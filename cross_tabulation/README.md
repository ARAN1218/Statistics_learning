# cross_tabulation
## 概要
インターンにてアンケートをクロス集計によって分析し、示唆を得る分析を経験しました。
クロス集計自体はそんなに難しいことではなく、条件を絞って集計することで様々な示唆が簡単に得られる事実に感動しました。  
ただ、中には差があるのかどうか微妙であったり、クロス集計を多重にし過ぎた為にサンプルサイズが小さくなって誤差と判別がつきにくくなってしまったものもありました。

その中で、それぞれの要素による差に数学的裏付けを付けるものとして統計的検定に目をつけました。googleスプレッドシートにてカイ二乗検定を実行しようとしたところ、
どうやらカイ二乗検定には注意点があるらしく、独立性の検定に興味が湧きました。そして例によって自動化したくなり、カイ二乗検定及びフィッシャーの正確確率検定をPythonで実装しました。

## リファレンス
### chi2_test
- クロス集計の適合度＆独立性の検定である。
- 主に名義尺度の変数に用いる。
- ある程度全体のサンプルサイズが大きい場合に用いられる。
- 適合度の検定において有意差が認められた場合は「実測値の分布は理論値の分布と一致しない」事が言える。
  - 帰無仮説：実測値の分布と理論値の分布は一致している
  - 対立仮説：実測値の分布と理論値の分布は一致していない
- 独立性の検定において有意差が認められた場合は「２要素に関係がある」事が言える。
  - 帰無仮説：要素１と要素２は独立である（関連がない）
  - 対立仮説：要素１と要素２は独立でない（関連がある）
- **独立性の検定における注意** ：期待度数の内、全体のセルの **20%以上** が5未満であった場合、この検定を用いるべきではない。その場合はフィッシャーの正確確率検定を採用する。(これをコクラン・ルールという。)  
(例えば、2✖️2のクロス集計表における期待度数にて一つでも5以下の値があった場合、4つの期待度数の内の1つであるので全体の25%に相当することが分かる。)

#### 使い方
##### 適合度の検定
テスト1

<img width="345" alt="スクリーンショット 2022-03-03 11 52 11" src="https://user-images.githubusercontent.com/67265109/156487198-259e0ad5-d4d3-4830-ae5e-654989e232ea.png">
テスト2

<img width="377" alt="スクリーンショット 2022-03-03 11 52 21" src="https://user-images.githubusercontent.com/67265109/156487209-6c8fe6cb-0c0b-41b1-bbfb-1a513e6cdb22.png">

1. 上記画像のデータフレームの様にクロス集計表を用意する。(testが検定対象のクロス集計表、theoryが分布理論値表)
2. この2つのデータフレームを引数としてchi2_test関数を実行する。
3. 上記画像の括弧内の2つの値の内、右が検定統計量χ^2、左がp値として出力される。

##### 独立性の検定
テスト1

<img width="699" alt="スクリーンショット 2022-02-25 18 49 31" src="https://user-images.githubusercontent.com/67265109/155693806-ec6daa6a-d88a-470b-91b2-0a28471a99a8.png">
テスト2

<img width="701" alt="スクリーンショット 2022-02-25 18 49 39" src="https://user-images.githubusercontent.com/67265109/155693955-bb531a65-d49d-4b2d-adc9-0104df160d8e.png">
テスト3

<img width="734" alt="スクリーンショット 2022-02-25 18 49 49" src="https://user-images.githubusercontent.com/67265109/155693962-2a46e53b-e735-4307-9b73-ba062550a618.png">

1. 上記画像のデータフレームの様にクロス集計表を用意する。
2. このデータフレームを引数としてchi2_test関数を実行する。
3. 上記画像の括弧内の4つの値の内、順に検定統計量χ^2(イェーツの補正無し)、p値(イェーツの補正無し)、検定統計量χ^2(イェーツの補正有り)、p値(イェーツの補正有り)として出力される。
4. 最後の画像の出力結果のように、期待度数の内全体のセルの **20%以上** が5未満であった場合、警告を出してくれる。この警告が出力された場合、以下のフィッシャーの正確確率検定の採用を検討する。


### fisher_exact_test
- クロス集計の独立性の検定である。
- 主に名義尺度の変数に用いる。
- 全体のサンプルサイズが小さい場合に用いられる。
- 有意差が認められた場合は「２要素に関係がある」事が言える。
  - 帰無仮説：要素１と要素２は独立である（関連がない）
  - 対立仮説：要素１と要素２は独立でない（関連がある）
- この検定はカイ二乗検定のような制約は特になく、どのような時にでも採用できる。
- この検定はp値を直接求めるため、検定統計量は存在しない。

#### 使い方
<img width="171" alt="スクリーンショット 2022-02-25 18 49 59" src="https://user-images.githubusercontent.com/67265109/155693933-88240194-7ac7-4a9d-ae4e-7bbb2b1cb537.png">

1. 上記画像のデータフレームの様にクロス集計表を用意する。
2. このデータフレームを引数としてfisher_exact_test関数を実行する。
3. 上記画像の通り、p値が返り値として出力される。


### odds_risk_ratio
|DEMO|結果1|結果2|行計|
|:-:|:-:|:-:|:-:|
|原因1|6|4|10|
|原因2|2|8|10|
|列計|8|12|20|
- オッズ比とは、結果1が原因1の時と原因2の時に起こるオッズ(=6/2=3)と、結果2が原因1の時と原因2の時に起こるオッズ(=4/8=0.5)の比率(=3/0.5=6)である。
  - オッズ比は結果に対する原因の「影響度」を表した指標である。オッズ比が1より大きければその原因と結果は相関しており、1より小さければ逆相関している。
  - オッズ比は原因1と原因2の結果1発生割合を表しているわけでは無いので、単にオッズ比が6だからと言って「原因1の時の方が原因2の時よりも6倍結果1になりやすい」とは**言えない**。
  - オッズ比はコホート研究(前向き研究)でもケースコントロール研究(後ろ向き研究)でも解析に利用できる。
- リスク比とは、原因1が結果1となるリスク(=6/10=0.6)と、原因2が結果1となるリスク(=2/10=0.2)の比率(=0.6/0.2=3)である。
  - リスク比はオッズ比と逆で原因1と原因2の結果1発生割合を表しているので、リスク比が3であれば「原因1の時の方が原因2の時よりも3倍結果1になりやすい」と**言える**。
  - リスク比はオッズ比と同様に1より大きければその原因と結果は相関しており、1より小さければ逆相関している。
  - リスク比はケースコントロール研究の解析には利用できるが、コホート研究の解析には利用できない。
- オッズ比・リスク比共にn%信頼区間を求め、それが1を跨いでいるかどうかで有意水準(1-n)%で統計的検定ができる。1より大きければ原因xは有意に結果yに影響し、1より小さければ原因xは有意に結果yに影響しないと言える。
- ある結果に対する原因が多数あると考えられる場合、ロジスティック回帰分析を使用して調整済みオッズ比を参照する。
- オッズ比とリスク比の順序は同じになるので、各原因の結果に対する影響度を比較するだけならオッズ比だけ分かれば良い。


#### 使い方
テスト1

<img width="383" alt="スクリーンショット 2022-03-15 21 07 54" src="https://user-images.githubusercontent.com/67265109/158374757-0b66fc8a-d54e-4e03-b990-5206ee57c78f.png">
テスト2

<img width="390" alt="スクリーンショット 2022-03-15 21 08 05" src="https://user-images.githubusercontent.com/67265109/158374777-c68487c5-962c-494f-9239-5a9031a6295c.png">


1. 上記画像のデータフレームの様に、行に原因(=結果に影響すると思われる因子)、列に結果を定めた分割表を作成する。
2. このデータフレームを引数としてodds_risk_ratio関数を実行する。
3. 上記画像の通り、オッズ比とリスク比の点推定値・95%信頼区間のデータフレームと、それを可視化したフォレストプロットを出力する。


### correspondence_analysis
- あるクロス集計表について、表頭項目と表側項目の関連性を散布図として可視化し、把握する為の手法である。
- ブランド・商品のポジショニングや、消費者の特徴を簡単に捉えることが可能である。
- 内容としては質的データの主成分分析に当たるもので、行と列のそれぞれについて実行している。
- 一般的に、固有値が1以上である軸は元データと関連性が高いとされ、2軸の合計寄与率が80%以上であると元データの情報をよく反映できていると見做される。
  - 量的データの主成分分析に比べて元データの情報量の損失率が高いとされている。
- コレスポンデンス分析(対応分析)を略して「コレポン」と呼ぶ場合が多い。

#### 使い方
<img width="985" alt="スクリーンショット 2022-03-30 13 22 56" src="https://user-images.githubusercontent.com/67265109/160750936-5ba376ec-0232-4216-95b4-095ebdb674e8.png">
<img width="214" alt="スクリーンショット 2022-03-14 22 05 04" src="https://user-images.githubusercontent.com/67265109/158177830-eba47fee-d3a1-4cd1-a663-ecbd94db10dc.png">
<img width="211" alt="スクリーンショット 2022-03-14 22 05 21" src="https://user-images.githubusercontent.com/67265109/158177848-516b0686-3702-4150-80a8-756a6094dd8e.png">
<img width="624" alt="スクリーンショット 2022-04-01 19 51 30" src="https://user-images.githubusercontent.com/67265109/161249820-9c8e3bc5-378a-4272-8d36-45621823b12b.png">


1. 上記画像のデータフレームの様にクロス集計表を用意する。
2. このデータフレームを引数としてcorrespondence関数を実行する。
3. 上記画像の通り、2軸の固有値・寄与率、散布図が返り値として出力される。(x=0,y=0の直線を水色の線で表している。)

(上記入力データの出典：https://github.com/esafak/mca/tree/master/data)


### マクネマー検定(mcnemar_test)
- 対応のあるペアの2値データを用いて2つの処理あるいは2つの調査の結果に差があるかどうかを検定する。
  - 帰無仮説：要素１と要素２の結果に差がない
  - 対立仮説：要素１と要素２の結果に差がある
- 通常、 **対応があるデータ** の場合には独立性の検定を使うことはできないが、本手法であれば有効である。
- **独立性の検定における注意** ：期待度数の内、全体のセルの **20%以上** が5未満であった場合、この検定を用いるべきではない。その場合はフィッシャーの正確確率検定を採用する。(これをコクラン・ルールという。)  
(例えば、2✖️2のクロス集計表における期待度数にて一つでも5以下の値があった場合、4つの期待度数の内の1つであるので全体の25%に相当することが分かる。)

#### 使い方
<img width="191" height="438" alt="image" src="https://github.com/user-attachments/assets/45452430-a05c-4d14-bf3d-38b397317d26" />
<img width="274" height="290" alt="image" src="https://github.com/user-attachments/assets/cdb19bbc-17a1-49c1-ac22-d3b6ffd11ac0" />

1. 上記画像のデータフレームの様に集計前のデータを用意する。
2. このデータフレームを引数としてmcnemar_test関数を実行する。
3. 検定統計量及びp値（イェーツの補正有の値も）が返り値として出力される。



### コクラン=アーミテージ検定(cochran_armitage_test)
- 順序尺度カテゴリと2値データからなるクロス集計表において、順序カテゴリの水準に伴う2値データの割合に線形的な傾向（トレンド）があるかを検定する。
  - 帰無仮説：順序カテゴリの水準に伴う2値データの割合に線形的な傾向（トレンド）がない
  - 対立仮説：順序カテゴリの水準に伴う2値データの割合に線形的な傾向（トレンド）がある
- 回帰係数が0であるかの検定のイメージ


#### 使い方
<img width="457" height="342" alt="image" src="https://github.com/user-attachments/assets/07b49e15-3927-4148-a5eb-a9c88e5d6905" />

1. 上記画像のデータフレームの様にクロス集計表を用意する。
2. このデータフレームを引数としてcochran_armitage_test関数を実行する。
3. 検定統計量等の分析表が返り値として出力される。



# 参考文献
- [統計学の時間(2025)](https://bellcurve.jp/statistics/course/)

